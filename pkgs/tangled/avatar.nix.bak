{ lib
, buildNpmPackage
, fetchFromTangled
, makeWrapper
, nodejs
, esbuild
}:

buildNpmPackage rec {
  pname = "tangled-avatar";
  version = "0.1.0";

  src = fetchFromTangled {
    domain = "tangled.org";
    owner = "@tangled.org";
    repo = "core";
    rev = "2e5a4cde904d86825cefe5971e68f1bdfb1dd36f";
    hash = "sha256-OcTD732dTYT69smyDSI6oi0vXSwnpJfLGxq7MGNqOus=";
  };

  sourceRoot = "${src.name}/avatar";

  npmDepsHash = "sha256-AI9MJXRtcQ17FLi7Lh8b5Rz7d8QkFFtuF0u0LHXFoR4=";

  nativeBuildInputs = [ makeWrapper esbuild ];
  
  # KEY FIX: Prevent postinstall scripts during dependency fetching
  # This stops esbuild from trying to download platform-specific binaries
  npmFlags = [ "--ignore-scripts" ];
  
  # After dependencies are installed, link to nixpkgs esbuild instead
  postPatch = ''
    # Replace esbuild binary with one from nixpkgs
    mkdir -p node_modules/.bin
    ln -sf ${esbuild}/bin/esbuild node_modules/.bin/esbuild

    # Patch avatar code to work in local dev mode (remove Cloudflare cf.image API)
    # The cf.image parameter only works on Cloudflare Workers, not in wrangler dev
    substituteInPlace src/index.js \
      --replace-fail \
'      // Resize if requested
      let avatarResponse;
      if (resizeToTiny) {
        avatarResponse = await fetch(avatarUrl, {
          cf: {
            image: {
              width: 32,
              height: 32,
              fit: "cover",
              format: "webp",
            },
          },
        });
      } else {
        avatarResponse = await fetch(avatarUrl);
      }' \
'      // Resize if requested (disabled for local wrangler dev)
      let avatarResponse = await fetch(avatarUrl);'

    # Wrap API fetch in try-catch to handle TLS errors in local dev
    substituteInPlace src/index.js \
      --replace-fail \
'    try {
      const profileResponse = await fetch(
        `https://public.api.bsky.app/xrpc/app.bsky.actor.getProfile?actor=''${actor}`,
      );
      const profile = await profileResponse.json();
      const avatar = profile.avatar;

      let avatarUrl = profile.avatar;

      if (!avatarUrl) {' \
'    try {
      let profileResponse, profile, avatarUrl;
      try {
        profileResponse = await fetch(
          `https://public.api.bsky.app/xrpc/app.bsky.actor.getProfile?actor=''${actor}`,
        );
        profile = await profileResponse.json();
        avatarUrl = profile.avatar;
      } catch (fetchError) {
        // Handle TLS/fetch errors in local dev (workerd TLS issues)
        avatarUrl = null;
      }

      if (!avatarUrl) {'
  '';
  
  dontNpmBuild = true;

  installPhase = ''
    runHook preInstall

    mkdir -p $out/{lib/avatar,bin}

    # Copy the worker source and config
    cp -r src $out/lib/avatar/
    cp wrangler.jsonc $out/lib/avatar/
    cp package.json $out/lib/avatar/
    cp -r node_modules $out/lib/avatar/

    # Create wrapper script that sets up writable directory and injects env vars
    cat > $out/bin/avatar <<'WRAPPER_EOF'
#!/bin/sh
# Wrangler needs a writable directory for runtime data
RUNTIME_DIR="''${RUNTIME_DIRECTORY:-$HOME/.cache/tangled-avatar}"
mkdir -p "$RUNTIME_DIR"

# Copy source files to writable directory if not already there
if [ ! -f "$RUNTIME_DIR/package.json" ]; then
  cp -r ${placeholder "out"}/lib/avatar/* "$RUNTIME_DIR/"
  chmod -R u+w "$RUNTIME_DIR/node_modules"
  chmod u+w "$RUNTIME_DIR/wrangler.jsonc"
fi

cd "$RUNTIME_DIR"

# Always regenerate wrangler config with environment variables bound
# This is needed because wrangler dev doesn't automatically expose process.env to the Worker's env object
chmod u+w wrangler.jsonc 2>/dev/null || true
cat > wrangler.jsonc <<WRANGLER_EOF
{
	"\$schema": "node_modules/wrangler/config-schema.json",
	"name": "avatar",
	"main": "src/index.js",
	"compatibility_date": "2025-05-03",
	"observability": {
		"enabled": true
	},
	"vars": {
		"AVATAR_SHARED_SECRET": "''${AVATAR_SHARED_SECRET:-}"
	}
}
WRANGLER_EOF

exec ${nodejs}/bin/node node_modules/wrangler/bin/wrangler.js dev \
  --port 8787 \
  --local-protocol http
WRAPPER_EOF
    chmod +x $out/bin/avatar

    runHook postInstall
  '';

  meta = with lib; {
    description = "Tangled Avatar Service - Bluesky avatar proxy and cache";
    longDescription = ''
      Avatar service for Tangled that fetches Bluesky avatars and caches them.
      Uses HMAC signatures to verify requests originate from trusted appview.

      Originally a Cloudflare Worker, packaged here for self-hosted deployment
      using Wrangler in development mode.

      Features:
      - Fetches avatars from Bluesky API
      - Generates fallback SVG avatars for users without avatars
      - Resizes images (supports ?size=tiny for 32x32 thumbnails)
      - HMAC signature verification for security
      - Caching support

      Environment variables:
      - AVATAR_SHARED_SECRET: Shared secret for HMAC verification (required)
    '';
    homepage = "https://tangled.org";
    license = licenses.mit;
    platforms = platforms.linux ++ platforms.darwin;
    maintainers = [ ];
    mainProgram = "avatar";
  };
}
