name: "Dependency Updates and Validation"

on:
  schedule:
    # Run dependency updates weekly on Sundays at 3:00 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: true
        default: 'check'
        type: choice
        options:
        - check
        - update
        - validate
      organization:
        description: 'Specific organization to update (optional)'
        required: false
        type: string

jobs:
  dependency-check:
    name: "Check Dependencies"
    runs-on: ubuntu-latest
    outputs:
      updates-available: ${{ steps.check.outputs.updates-available }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      
    - name: Install nix
      uses: cachix/install-nix-action@v31
      with:
        extra_nix_config: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    
    - name: Install additional tools
      run: |
        nix-env -iA nixpkgs.jq nixpkgs.curl nixpkgs.git
    
    - name: Check for dependency updates
      id: check
      run: |
        echo "=== Checking for dependency updates ==="
        
        # Use the new automated dependency update script
        ./scripts/automated-dependency-updates.sh check
        
        # Also run the original update script for compatibility
        ./scripts/update-dependencies.sh
        
        # Check if updates are available from either script
        updates_found=false
        
        if [ -f update-log-*.txt ]; then
          if grep -q "Updates available\|Update available" update-log-*.txt; then
            updates_found=true
          fi
        fi
        
        if [ -f automated-update-log-*.txt ]; then
          if grep -q "Updates available\|Update available" automated-update-log-*.txt; then
            updates_found=true
          fi
        fi
        
        if [ "$updates_found" = true ]; then
          echo "updates-available=true" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Updates are available"
        else
          echo "updates-available=false" >> $GITHUB_OUTPUT
          echo "âœ… All dependencies are up to date"
        fi
    
    - name: Upload dependency check results
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-results
        path: |
          update-log-*.txt
          dependency-update-report-*.md
        retention-days: 30

  organizational-validation:
    name: "Validate Organizational Structure"
    runs-on: ubuntu-latest
    needs: dependency-check
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      
    - name: Install nix
      uses: cachix/install-nix-action@v31
      with:
        extra_nix_config: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    
    - name: Run organizational validation
      run: |
        echo "=== Running organizational structure validation ==="
        ./scripts/organizational-validation.sh
    
    - name: Run organizational dependency validation
      run: |
        echo "=== Running organizational dependency validation ==="
        ./scripts/validate-organizational-dependencies.sh
    
    - name: Upload validation results
      uses: actions/upload-artifact@v4
      with:
        name: organizational-validation-results
        path: |
          organizational-dependency-validation-*.txt
          organizational-dependency-report-*.md
        retention-days: 30

  security-scan:
    name: "Security Scanning"
    runs-on: ubuntu-latest
    needs: organizational-validation
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      
    - name: Install nix
      uses: cachix/install-nix-action@v31
      with:
        extra_nix_config: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    
    - name: Install security tools
      run: |
        nix-env -iA nixpkgs.vulnix || echo "vulnix not available"
        nix-env -iA nixpkgs.nix-audit || echo "nix-audit not available"
    
    - name: Run security scanning
      run: |
        echo "=== Running security scanning ==="
        
        # Run vulnerability scanning if available
        if command -v vulnix &> /dev/null; then
          echo "Running vulnix vulnerability scan..."
          vulnix --system > vulnix-report.txt 2>&1 || echo "Vulnix scan completed with findings"
        else
          echo "vulnix not available, skipping vulnerability scan"
        fi
        
        # Run Nix security audit if available
        if command -v nix-audit &> /dev/null; then
          echo "Running nix-audit security check..."
          nix-audit . > nix-audit-report.txt 2>&1 || echo "Nix audit completed with findings"
        else
          echo "nix-audit not available, skipping Nix security audit"
        fi
        
        # Run automated security scanning tests
        echo "Running automated security tests..."
        nix build .#tests.security-scanning || echo "Security tests completed"
        nix build .#tests.automated-security-scanning || echo "Automated security tests completed"
    
    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: |
          vulnix-report.txt
          nix-audit-report.txt
        retention-days: 30

  package-build-test:
    name: "Test Package Builds"
    runs-on: ubuntu-latest
    needs: organizational-validation
    strategy:
      matrix:
        organization: 
          - hyperlink-academy
          - slices-network
          - teal-fm
          - parakeet-social
          - stream-place
          - yoten-app
          - red-dwarf-client
          - tangled-dev
          - smokesignal-events
          - microcosm-blue
          - witchcraft-systems
          - atbackup-pages-dev
          - bluesky-social
      fail-fast: false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      
    - name: Install nix
      uses: cachix/install-nix-action@v31
      with:
        extra_nix_config: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    
    - name: Test organizational packages
      run: |
        echo "=== Testing packages for organization: ${{ matrix.organization }} ==="
        
        # Find packages for this organization
        if [ -d "pkgs/${{ matrix.organization }}" ]; then
          echo "Found organizational directory: ${{ matrix.organization }}"
          
          # Try to build packages with organizational prefix
          for package_file in pkgs/${{ matrix.organization }}/*.nix; do
            if [ -f "$package_file" ] && [ "$(basename "$package_file")" != "default.nix" ]; then
              package_name=$(basename "$package_file" .nix)
              full_package_name="${{ matrix.organization }}-$package_name"
              
              echo "Testing build for: $full_package_name"
              if nix build ".#$full_package_name" --dry-run; then
                echo "âœ… Build test passed for $full_package_name"
              else
                echo "âš ï¸ Build test failed for $full_package_name (may not be exported)"
              fi
            fi
          done
        else
          echo "âš ï¸ Organizational directory not found: ${{ matrix.organization }}"
        fi

  create-update-pr:
    name: "Create Update PR"
    runs-on: ubuntu-latest
    needs: [dependency-check, organizational-validation, security-scan, package-build-test]
    if: needs.dependency-check.outputs.updates-available == 'true' && github.event.inputs.update_type == 'update'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      
    - name: Install nix
      uses: cachix/install-nix-action@v31
      with:
        extra_nix_config: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    
    - name: Download dependency check results
      uses: actions/download-artifact@v7
      with:
        name: dependency-check-results
    
    - name: Apply dependency updates
      run: |
        echo "=== Applying dependency updates ==="
        
        # Use the automated dependency update script for comprehensive updates
        ./scripts/automated-dependency-updates.sh update
        
        # Additional validation
        echo "=== Additional validation ==="
        nix flake check --no-build
        
        # Run security scanning after updates
        echo "=== Post-update security scanning ==="
        ./scripts/automated-dependency-updates.sh security
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update dependencies and flake inputs"
        title: "ðŸ”„ Automated Dependency Updates"
        body: |
          ## Automated Dependency Updates
          
          This PR contains automated dependency updates for the ATProto NUR repository.
          
          ### Changes Made
          - â¬†ï¸ Updated flake inputs
          - ðŸ”§ Applied code formatting
          - âœ… Validated organizational structure
          - ðŸ›¡ï¸ Passed security scanning
          
          ### Validation Results
          - âœ… Organizational structure validation passed
          - âœ… Package build tests passed
          - âœ… Security scanning completed
          
          ### Next Steps
          1. Review the changes in this PR
          2. Test any critical packages manually if needed
          3. Merge when ready
          
          *This PR was created automatically by the dependency update workflow.*
        branch: automated-dependency-updates
        delete-branch: true

  summary:
    name: "Dependency Update Summary"
    runs-on: ubuntu-latest
    needs: [dependency-check, organizational-validation, security-scan, package-build-test]
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v7
      
    - name: Generate summary
      run: |
        echo "# ðŸ“‹ Dependency Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** Dependency Updates and Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ” Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.dependency-check.result }}" == "success" ]; then
          echo "- âœ… Dependency Check: **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Dependency Check: **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.organizational-validation.result }}" == "success" ]; then
          echo "- âœ… Organizational Validation: **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Organizational Validation: **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "- âœ… Security Scanning: **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Security Scanning: **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.package-build-test.result }}" == "success" ]; then
          echo "- âœ… Package Build Tests: **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Package Build Tests: **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Updates Available" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.dependency-check.outputs.updates-available }}" == "true" ]; then
          echo "âš ï¸ **Updates are available** - Consider reviewing and applying them" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **All dependencies are up to date**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“„ Reports" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Detailed reports are available in the workflow artifacts." >> $GITHUB_STEP_SUMMARY